## Vault architecture:
Vault architecture involves several components, and the interactions between Vault, the Vault Agent, and Kubernetes pods depend on the use case and configurations. 
Below is a simplified explanation of how these components interact in a Kubernetes environment:

### Vault:

#### Vault Server: 
The central component responsible for storing, managing, and controlling access to secrets. The Vault server exposes an HTTP API for clients to interact with.

### Vault Agent Injector:
The vault-agent-injector is a Kubernetes admission controller webhook that automatically injects the Vault Agent sidecar container (vault-agent and vault-agent-init container) into your pods. 
It intercepts pod creation or update events and injects the necessary containers and configurations based on annotations in the pod's definition.

#### Purpose:
Automates the process of injecting the Vault Agent sidecar container into pods.
Simplifies the configuration for users, as they don't need to manually add the vault-agent container to their pod definitions.

#### Configuration:
You configure the vault-agent-injector with annotations in your pod specifications to indicate which secrets from Vault should be injected and how the vault-agent container should be configured.


## vault-agent-init Container:

The vault-agent-init container is an initialization container that runs before the main application container in a Kubernetes pod. 
Its primary role is to perform the initial setup needed for the vault-agent to operate.

### Key Functions:

- Token Initialization: The vault-agent-init container is responsible for obtaining a short-lived Vault token during pod startup. This token is then passed to the vault-agent.
- Authentication: It handles the initial authentication with Vault, typically using Kubernetes service account credentials.

Configuration:

The configuration for the vault-agent-init container is also specified in annotations within the pod definition. These annotations dictate how the vault-agent-init container authenticates with Vault and obtains the initial token.
vault-agent:

The vault-agent container is a sidecar container that runs alongside the main application container in a Kubernetes pod. 
Its primary purpose is to manage the lifecycle of Vault tokens and dynamically retrieve and renew secrets from Vault.

#### Key Functions:

- Token Management: The vault-agent manages the lifecycle of a long-lived Vault token. It can automatically renew the token to prevent expiration.
- Secret Retrieval: The vault-agent is responsible for interacting with Vault to dynamically retrieve secrets. It can inject these secrets into the main application container in various formats (e.g., environment variables, files).
- Dynamic Secrets:

The vault-agent is particularly useful for managing dynamic secrets generated by Vault. It can handle the periodic renewal of such secrets without requiring manual intervention.
Configuration:

The configuration for the vault-agent is often specified in annotations within the pod definition. These annotations dictate how the vault-agent interacts with Vault and which secrets it should manage.

### Overall Workflow:

- The vault-agent-init container runs first during pod startup, authenticates with Vault using Kubernetes service account credentials, and obtains a short-lived token.
- The short-lived token is passed to the vault-agent container.
- The vault-agent uses the short-lived token to authenticate with Vault, obtain a long-lived token, and manage the renewal of the token.
- The vault-agent dynamically retrieves and injects secrets into the main application container.

## How does Kubernetes auth work in Hashicorp vault ?
The Kubernetes authentication method in HashiCorp Vault allows Kubernetes clusters and applications running within those clusters to authenticate with Vault. This integration helps manage and secure access to secrets and other resources in Vault based on Kubernetes identity. Here's an overview of how Kubernetes authentication works in HashiCorp Vault:

Step-by-Step Explanation:
- Enable Kubernetes Auth Method
- Configure Kubernetes Authentication
- Create Role
- Deploy Application
- Authenticate with Vault
- Use Vault Token

## The relationship between the Vault policies, Kubernetes roles, and the associated service account is as follows:

### 1. Vault Policy (basic-secret-policy):

Defines the permissions for the specified path in Vault (secret/data/basic-secret/*). In our case, it grants read capabilities for that path.

```shell
curl --cacert /home/sysadmin/vault_ca.pem \
    --header "X-Vault-Token:$ROOT_TOKEN" \
    -H "Content-Type: application/json" \
    --request PUT \
    -d '{"policy":"path \"secret/data/basic-secret/*\" {capabilities = [\"read\"]}"}' \
    https://sva-vault-active.vault.svc.cluster.local:8200/v1/sys/policy/basic-secret-policy
```

### 2. Vault Kubernetes Role (basic-secret-role):

Associates the Vault policy (basic-secret-policy) with Kubernetes RBAC, specifying details such as the bound service account (basic-secret), its namespace (pvtest), and the maximum time to live (max_ttl).

```shell
curl --cacert /home/sysadmin/vault_ca.pem \
   --header "X-Vault-Token:$ROOT_TOKEN" \
    --request POST \
    --data '{ "bound_service_account_names": "basic-secret",  "bound_service_account_namespaces": "pvtest",  "policies": "basic-secret-policy",  "max_ttl": "1800000"}' \
    https://sva-vault-active.vault.svc.cluster.local:8200/v1/auth/kubernetes/role/basic-secret-role
```

### 3. Kubernetes Service Account (basic-secret):

Specifies the service account (basic-secret) that is associated with the pod.

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: basic-secret
  namespace: pvtest
  labels:
    app: basic-secret
```

### 4. ClusterRoleBinding (pvtest-user-clusterrolebinding):

Binds the Kubernetes service account (basic-secret) to a Kubernetes ClusterRole (cluster-admin in this case).

```yaml
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pvtest-user-clusterrolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: basic-secret
  namespace: pvtest
```

In summary, the basic-secret-policy defines Vault permissions, the basic-secret-role associates those permissions with Kubernetes RBAC, and the basic-secret service account is bound to a Kubernetes ClusterRole (cluster-admin). The Kubernetes ClusterRole (cluster-admin) provides sufficient permissions for the pod to interact with Vault.



