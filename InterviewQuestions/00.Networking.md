## How Kubernetes Pod IP Allocation happens?
<details>

Kubernetes Pod IP Allocation with CIDR and IPAM
Kubernetes uses Classless Inter-Domain Routing (CIDR) to allocate IP addresses to Pods. The CIDR notation specifies the range (subnet) of IPs available for assignment within the cluster.

### 1. CIDR-Based Pod IP Allocation
When you configure a Kubernetes cluster, you define a cluster-wide CIDR range that will be used for assigning Pod IPs. This is specified using the --pod-network-cidr flag when starting the cluster (e.g., in kubeadm or cloud provider settings).

#### Example:
```sh
kubeadm init --pod-network-cidr=10.244.0.0/16
```

10.244.0.0/16 is the CIDR block for Pods.
Each node will be assigned a subset of this range.

### How it works:

#### Cluster-wide CIDR Assignment

The entire cluster is assigned a large CIDR block (e.g., 10.244.0.0/16).

#### Node-specific CIDR Subnet

Each Node gets a smaller subnet (e.g., 10.244.1.0/24) from the cluster CIDR.
Kubernetes assigns these subnets dynamically to Nodes.
The Controller Manager (kube-controller-manager) handles the allocation.

#### Pod IP Allocation from Node's CIDR

When a Pod is scheduled on a Node, it gets an IP from that Node’s assigned subnet.
Example:

```
Node 1: 10.244.1.0/24 → Pod 1: 10.244.1.2, Pod 2: 10.244.1.3
Node 2: 10.244.2.0/24 → Pod 3: 10.244.2.2, Pod 4: 10.244.2.3
```
This ensures Pod-to-Pod communication without NAT inside the cluster.

### 2. IP Address Management (IPAM) in Kubernetes
Kubernetes allows IP Address Management (IPAM) for more flexibility in assigning IPs. Many CNI plugins (Calico, Flannel, Cilium, etc.) support advanced IP allocation strategies.

#### Features of IPAM:
- Dynamic Allocation: Automatically assigns IPs to Pods based on availability.
- Custom Subnets and Pools: Users can define multiple subnet pools.
- Static IP Assignment: Some CNI plugins allow manual assignment of Pod IPs.
- Prefixes & Ranges: You can specify different subnets per namespace or application.

Example of Custom IPAM (Calico)
Define custom IP pools:

```yaml
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  name: my-custom-pool
spec:
  cidr: 192.168.1.0/24
  blockSize: 26
  ipipMode: Always
  natOutgoing: true
```

This allows Kubernetes to use specific subnet pools for different workloads.
</details>

## Pod-to-Pod communication in same node and across nodes 

<details>

### Step-by-Step Communication Between Pods on the Same Node

![image](https://github.com/user-attachments/assets/68df6193-856d-41cf-8916-58d7bf406f6a)

#### Pod Creation

- When a Pod is created, Kubernetes (through the CNI plugin) assigns it an IP from the Node's subnet.
- The Pod is given a network interface (eth0 inside the Pod).
- The Node gets a corresponding virtual Ethernet interface (vethX).

#### veth Pair Creation

- Each Pod is connected to the Node via a veth pair:
- Inside the Pod: eth0
- On the Node: veth0, veth1, veth2, etc.
- These interfaces are connected to a bridge on the Node (usually cbr0 or docker0 depending on the CNI).

Bridge Networking Inside the Node

- The Node has a virtual Linux bridge (cbr0) that acts like a small internal switch.
- All veth interfaces are plugged into this bridge.
- The bridge forwards traffic between Pods on the same Node.

### Pod-to-Pod Communication (Same Node)

- When Pod A wants to talk to Pod B, it sends a packet to Pod B’s IP.
- The packet leaves Pod A’s eth0, goes through its veth pair, and enters the bridge (cbr0).
- The bridge directly forwards the packet to Pod B’s veth interface.
- Pod B receives the packet on eth0, completing the communication.

### Pod-to-Pod Communication Across Different Nodes in Kubernetes
When two Pods are running on different Nodes, their communication requires inter-node networking. Kubernetes achieves this using Node routing, CNI plugins, and Pod CIDRs.

Unlike Pods on the same Node (which communicate via a bridge), Pods on different Nodes must send packets over the network.

Here’s how Kubernetes makes this possible:

Step-by-Step Cross-Node Communication

- Each Node Gets a Subnet (Pod CIDR)
- Kubernetes assigns a Pod CIDR (subnet) per Node.

Example:

Node 1: 10.244.1.0/24

Node 2: 10.244.2.0/24

This ensures that Pod IPs are unique across the cluster.

Pods Communicate Using Direct IPs

Each Pod has a unique IP from its Node’s CIDR.

Kubernetes does not use NAT between Pods (they see each other’s real IPs).

Routing Between Nodes

- The Node’s kernel maintains routes for other Nodes' subnets.
- If Pod A (Node 1) wants to talk to Pod B (Node 2):
- It sends a packet to Pod B’s IP (10.244.2.3).
- The Node 1 kernel sees that 10.244.2.0/24 is on Node 2.
- It routes the packet to Node 2 using the cluster network.


